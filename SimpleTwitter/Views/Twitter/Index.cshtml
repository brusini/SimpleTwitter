
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="post-form">
    <form>
        <input type="text" id="txtMsg" />
        <input type="submit" id="btnPost" value="Post" title="Post" disabled="true" />
    </form>
</div>

<div id="dialog-form" title="Login">
    <form>
        <fieldset>
            <label for="userName">User Name</label>
            <input type="text" name="userName" id="userName" value="" class="text ui-widget-content ui-corner-all">
            <input type="submit" id="sbmUserName" tabindex="-1" style="position: absolute; top: -1000px">
        </fieldset>
    </form>
</div>
<p>
    <div id="results"></div>
</p>

@section scripts{
    <style>
        label, input {
            display: block;
        }

            input.text {
                margin-bottom: 12px;
                width: 95%;
                padding: .4em;
            }

        fieldset {
            padding: 0;
            border: 0;
            margin-top: 25px;
        }

        h1 {
            font-size: 1.2em;
            margin: .6em 0;
        }

        .ui-dialog .ui-state-error {
            padding: .3em;
        }

        .validateTips {
            border: 1px solid transparent;
            padding: 0.3em;
        }

        .userName {
            color: #fff;
        }
    </style>
    <script id="postTemplate" type="text/x-jquery-tmpl">
        <p>
            <div>
                <div>${UserName} ${Manager.formatDate(DatePosted)}</div>
                <div>${TextMessage}</div>
            </div>
            <hr />
        </p>
    </script>

    <script type="text/javascript">


        var Manager = {
            formatDate: function (date) {
                var d = date == null ? new Date() : new Date(date);
                return $.datepicker.formatDate("M d, yy", d) + " " + d.getHours() + ":" + d.getMinutes();
            }
        };

        $(function () {

            var userName = null, tips = $(".validateTips"), txtUserName = $("#userName"), skip = 0;

            var dialog = $("#dialog-form").dialog({
                autoOpen: true,
                width: 450,
                modal: true,
                buttons: {
                    "Login": doLogin
                }
            });

            function doLogin() {
                var valid = true;
                var allFields = $([]).add(txtUserName);
                allFields.removeClass("ui-state-error");

                valid = valid && checkLength(txtUserName, "userName", 3, 16);
                if (valid) {
                    userName = txtUserName.val();
                    dialog.dialog("close");
                    $("#btnPost").attr('disabled', false);
                    $('.userName').html("&#64;" + userName);
                    $('#txtMsg').focus();
                }
                return valid;
            };

            function addMessage() {
                var text = $('#txtMsg').val();
                $.ajax("/api/messages/add", {
                    data: {
                        UserName: userName,
                        Message: text
                    },
                    dataType: "json",
                    type: "POST",
                    success: function () {
                        var d = new Date();
                        var data = [{
                            TextMessage: text.trim(),
                            UserName: userName,
                            DatePosted: Manager.formatDate()
                        }];

                        $("#postTemplate").tmpl(data).prependTo("#results");
                        $('#txtMsg').val('');
                        $('#txtMsg').focus();
                    },
                    error: function (e, s) {
                        console.log(e);
                    }
                });
            };

            function getMessages() {
                var data = {
                    take: 10,
                    skip: skip
                };

                $.ajax("/api/messages", {
                    data: data,
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        console.log(data);
                        $("#postTemplate").tmpl(data).appendTo("#results");
                        skip += 10;
                    },
                    error: function (e, s) {
                        console.log(e);
                    }
                });
            };

            function updateTips(t) {
                tips
                    .text(t)
                    .addClass("ui-state-highlight");
                setTimeout(function () {
                    tips.removeClass("ui-state-highlight", 1500);
                }, 500);
            }

            function checkLength(o, n, min, max) {
                if (o.val().length > max || o.val().length < min) {
                    o.addClass("ui-state-error");
                    updateTips("Length of " + n + " must be between " +
                        min + " and " + max + ".");
                    return false;
                } else {
                    return true;
                }
            };

            //$('#results').jscroll();

            $(window).endlessScroll({
                fireOnce: false,
                fireDelay: 5,
                loader: '<div class="loading"><div>',
                callback: function (p) {
                    alert();
                    getMessages();
                }
            });

            $("#post-form").submit(function (event) {
                addMessage();
                event.preventDefault();
            });

            $("#dialog-form").submit(function (event) {
                doLogin();
                event.preventDefault();
            });

            dialog.dialog("open");
            getMessages();
        });
    </script>
}